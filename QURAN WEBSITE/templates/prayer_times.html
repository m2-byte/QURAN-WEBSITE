{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="page-header">
        <h1>ููุงููุช ุงูุตูุงุฉ</h1>
        <p>ุฃููุงุช ุงูุตูุงุฉ ุงูุฏูููุฉ ุญุณุจ ูููุนู ุงูุฌุบุฑุงูู</p>
    </div>

    <div style="max-width:500px;margin:0 auto;">
        <div class="text-center mb-3">
            <button onclick="getPrayerTimes()" class="btn btn-primary" id="locationBtn">
                ๐ ุชุญุฏูุฏ ูููุนู
            </button>
        </div>

        <div id="prayerContainer" class="hidden">
            <div class="settings-panel text-center mb-2">
                <p class="text-secondary" id="hijriDisplay" style="font-family:'Amiri',serif;font-size:1.3rem;"></p>
            </div>

            <div class="prayer-grid">
                <div class="prayer-row" data-prayer="Fajr">
                    <span class="prayer-name">๐ ุงููุฌุฑ</span>
                    <span class="prayer-time-value" id="time-fajr">--:--</span>
                </div>
                <div class="prayer-row" data-prayer="Sunrise">
                    <span class="prayer-name">โ๏ธ ุงูุดุฑูู</span>
                    <span class="prayer-time-value" id="time-sunrise">--:--</span>
                </div>
                <div class="prayer-row" data-prayer="Dhuhr">
                    <span class="prayer-name">๐ ุงูุธูุฑ</span>
                    <span class="prayer-time-value" id="time-dhuhr">--:--</span>
                </div>
                <div class="prayer-row" data-prayer="Asr">
                    <span class="prayer-name">๐ค๏ธ ุงูุนุตุฑ</span>
                    <span class="prayer-time-value" id="time-asr">--:--</span>
                </div>
                <div class="prayer-row" data-prayer="Maghrib">
                    <span class="prayer-name">๐ ุงููุบุฑุจ</span>
                    <span class="prayer-time-value" id="time-maghrib">--:--</span>
                </div>
                <div class="prayer-row" data-prayer="Isha">
                    <span class="prayer-name">๐ ุงูุนุดุงุก</span>
                    <span class="prayer-time-value" id="time-isha">--:--</span>
                </div>
            </div>
        </div>

        <div id="prayerLoading" class="loader hidden">
            <div class="spinner"></div>
            <p>ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...</p>
        </div>
    </div>
</div>

<script>
    // Auto-load from cache on page load
    (function () {
        const cached = localStorage.getItem('cached_prayer_data');
        if (cached) {
            try {
                const data = JSON.parse(cached);
                applyPrayerTimes(data);
            } catch (e) { }
        }
    })();

    function applyPrayerTimes(data) {
        const container = document.getElementById('prayerContainer');
        if (data.times) {
            document.getElementById('time-fajr').textContent = data.times.Fajr;
            document.getElementById('time-sunrise').textContent = data.times.Sunrise;
            document.getElementById('time-dhuhr').textContent = data.times.Dhuhr;
            document.getElementById('time-asr').textContent = data.times.Asr;
            document.getElementById('time-maghrib').textContent = data.times.Maghrib;
            document.getElementById('time-isha').textContent = data.times.Isha;
            if (data.hijri) {
                document.getElementById('hijriDisplay').textContent = data.hijri;
            }
            container.classList.remove('hidden');
            highlightNextPrayer(data.times);
            // Cache for vip.js prayer time notifier
            localStorage.setItem('cached_prayer_times', JSON.stringify(data.times));
        }
    }

    function getPrayerTimes() {
        const btn = document.getElementById('locationBtn');
        const loading = document.getElementById('prayerLoading');
        const container = document.getElementById('prayerContainer');

        btn.disabled = true;
        btn.textContent = 'โณ ุฌุงุฑู ุงูุชุญุฏูุฏ...';
        loading.classList.remove('hidden');
        container.classList.add('hidden');

        if (!navigator.geolocation) {
            if (typeof showToast === 'function') showToast('ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน');
            resetBtn();
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (pos) {
                fetch(`/api/prayer-times?lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`)
                    .then(r => r.json())
                    .then(data => {
                        applyPrayerTimes(data);
                        // Save to localStorage for persistence
                        localStorage.setItem('cached_prayer_data', JSON.stringify(data));
                        loading.classList.add('hidden');
                        resetBtn();
                    })
                    .catch(() => {
                        if (typeof showToast === 'function') showToast('ุฎุทุฃ ูู ุฌูุจ ุงูููุงููุช');
                        loading.classList.add('hidden');
                        resetBtn();
                    });
            },
            function () {
                if (typeof showToast === 'function') showToast('ุงูุฑุฌุงุก ุงูุณูุงุญ ุจุงููุตูู ุฅูู ุงููููุน');
                loading.classList.add('hidden');
                resetBtn();
            }
        );

        function resetBtn() { btn.disabled = false; btn.textContent = '๐ ุชุญุฏูุฏ ูููุนู'; }
    }

    function highlightNextPrayer(times) {
        const now = new Date();
        const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        for (const p of prayers) {
            const [h, m] = (times[p] || '').split(':').map(Number);
            const pTime = new Date(); pTime.setHours(h, m, 0);
            if (pTime > now) {
                document.querySelector(`[data-prayer="${p}"]`)?.classList.add('next');
                break;
            }
        }
    }
</script>
{% endblock %}