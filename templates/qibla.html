{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="page-header">
        <h1>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</h1>
        <p>Ø­Ø¯Ø¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø© Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…</p>
    </div>

    <div style="max-width:420px;margin:0 auto;">
        <div class="text-center mb-3">
            <button onclick="findQibla()" class="btn btn-primary" id="qiblaBtn">ğŸ§­ ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</button>
        </div>

        <div id="qiblaResult" class="hidden">
            <div class="card text-center" style="padding:3rem 2rem;">
                <!-- Compass -->
                <div style="width:180px;height:180px;margin:0 auto 2rem;position:relative;">
                    <div
                        style="width:100%;height:100%;border:3px solid var(--border-color);border-radius:50%;position:relative;">
                        <div
                            style="position:absolute;top:8px;left:50%;transform:translateX(-50%);font-size:0.75rem;color:var(--text-tertiary);">
                            N</div>
                        <div
                            style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:0.75rem;color:var(--text-tertiary);">
                            S</div>
                        <div
                            style="position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:0.75rem;color:var(--text-tertiary);">
                            W</div>
                        <div
                            style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:0.75rem;color:var(--text-tertiary);">
                            E</div>
                        <div id="qiblaArrow"
                            style="position:absolute;top:50%;left:50%;transform-origin:center;transition:transform 0.8s cubic-bezier(0.34,1.56,0.64,1);">
                            <div
                                style="width:3px;height:70px;background:linear-gradient(var(--primary-500),var(--primary-700));border-radius:2px;transform:translate(-50%,-100%);">
                            </div>
                            <div
                                style="width:12px;height:12px;background:var(--primary-500);border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 10px rgba(16,185,129,0.5);">
                            </div>
                        </div>
                    </div>
                    <div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);font-size:1.5rem;">ğŸ•‹
                    </div>
                </div>

                <p style="font-size:2.5rem;font-weight:800;color:var(--primary-500);" id="qiblaAngle">0Â°</p>
                <p class="text-secondary mb-3">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</p>

                <div style="padding-top:1.5rem;border-top:1px solid var(--border-color);">
                    <p class="text-secondary">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©</p>
                    <p style="font-size:1.5rem;font-weight:700;color:var(--accent-500);" id="qiblaDistance">â€”</p>
                </div>
            </div>
        </div>

        <div id="qiblaLoading" class="hidden text-center py-4">
            <div class="spinner" style="margin:0 auto;"></div>
            <p class="text-secondary mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</p>
        </div>
    </div>
</div>

<script>
    window.isQiblaLocating = false;

    function findQibla() {
        if (window.isQiblaLocating) return;

        const btn = document.getElementById('qiblaBtn');
        const loading = document.getElementById('qiblaLoading');
        const result = document.getElementById('qiblaResult');
        let hasResultProcessed = false;

        window.isQiblaLocating = true;
        btn.disabled = true;
        btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...';
        if (loading) loading.classList.remove('hidden');
        result.classList.add('hidden');

        // Function to process coordinates
        const processCoordinates = (lat, lng, source) => {
            if (hasResultProcessed) return;
            hasResultProcessed = true;

            fetch(`/api/qibla?lat=${lat}&lng=${lng}`)
                .then(r => r.json())
                .then(data => {
                    if (data.direction !== undefined) {
                        document.getElementById('qiblaAngle').textContent = Math.round(data.direction) + 'Â°';
                        document.getElementById('qiblaDistance').textContent = Math.round(data.distance).toLocaleString() + ' ÙƒÙ…';
                        document.getElementById('qiblaArrow').style.transform = `rotate(${data.direction}deg)`;
                        result.classList.remove('hidden');
                        if (source === 'ip') {
                            if (typeof showToast === 'function') showToast('âš ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ‚Ø±ÙŠØ¨ÙŠØ§Ù‹ (Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)');
                        }
                    } else {
                        throw new Error('Invalid data');
                    }
                    finish();
                })
                .catch(() => {
                    if (typeof showToast === 'function') showToast('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
                    finish();
                });
        };

        // Fallback: IP Geolocation (Server-side Proxy)
        const tryIpLocation = () => {
            if (hasResultProcessed) return;
            // Check visibility again
            if (!document.getElementById('qiblaResult').classList.contains('hidden')) {
                finish();
                return;
            }

            fetch('/api/ip-geo')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        console.log("Using IP Location (Proxy):", data.latitude, data.longitude);
                        processCoordinates(data.latitude, data.longitude, 'ip');
                    } else {
                        throw new Error('IP Geo failed');
                    }
                })
                .catch(() => {
                    if (!hasResultProcessed) {
                        if (typeof showToast === 'function') showToast('âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹');
                    }
                    finish();
                });
        };

        if (!navigator.geolocation) {
            tryIpLocation();
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (pos) {
                processCoordinates(pos.coords.latitude, pos.coords.longitude, 'gps');
            },
            function (err) {
                console.warn("GPS Access Denied/Error:", err.code, err.message);
                if (hasResultProcessed) return;
                setTimeout(tryIpLocation, 500);
            },
            { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
        );

        function finish() {
            if (loading) loading.classList.add('hidden');
            window.isQiblaLocating = false;
            btn.disabled = false;
            btn.textContent = 'ğŸ§­ ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©';
            // Reset after delay to allow re-try if needed, but simplistic reset is fine here
        }
    }
</script>
{% endblock %}